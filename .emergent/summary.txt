<analysis>
**original_problem_statement**:
The user wants to build a mobile app called Cloud District Club for the local pickup of disposable vape products, restricted to users aged 21 and over.

**PRODUCT REQUIREMENTS:**
*   **Age Verification:** Mandatory 21+ age gate.
*   **Design:** Dark, premium, fast, simple UI.
*   **Home Screen:** Featured products, shop by brand, loyalty points display, clear Order for Local Pickup CTA.
*   **Product Catalog:** Category organization with detailed product views.
*   **Checkout Flow:** Local pickup only, manual payment methods.
*   **Order Status System:** Track order progress.
*   **Loyalty Program (Cloudz Points):** Tier-based system with streak bonus.
*   **Referral Program:** Code-based system with deep linking.
*   **User Accounts:** Order history, loyalty status, profile management.
*   **Admin Dashboard:** Full CRUD on products, brands, users, inventory, orders.
*   **Contact & Support:** Ticket system.
*   **Live Chat:** Real-time WebSocket chat with typing indicators and read receipts.
*   **Bulk Discount:** Automatically apply 10% discount when total cart quantity >= 10.
*   **Future Features:** Push notifications expansion.

**User's preferred language**: English

**what currently exists?**
Full-stack Expo (React Native + Expo Router + TypeScript) frontend with FastAPI + MongoDB backend deployed on Railway. Dark premium theme implemented.

Live chat (WebSocket), loyalty system, referral system, push notifications, admin dashboard, performance pass, and reusable ProductCard component exist.

Recent changes include:
- Native hero layout fix attempt (vh replacement)
- Chat FAB visibility update
- Typing indicators + read receipts implementation
- 10% bulk discount logic in cart store and UI

**Last working item**:
- **Last item agent was working**:
    1. Native layout parity fix (web vs Expo Go).
    2. Chat enhancements (typing indicators + read receipts).
    3. 10% bulk cart discount implementation.
- **Status**: IN PROGRESS — fixes implemented but NOT verified.
- **Agent Testing Done**: N
- **Which testing method agent to use?**:
    1. Screenshot verification (Expo Go on iPhone 14 viewport).
    2. testing_agent_v3_fork full regression (chat, cart, layout).
- **User Testing Done**: N

**All Pending/In progress Issue list**:
- Issue 1 (P0): Native Expo layout does not match mobile web.
- Issue 2 (P0): Chat FAB must be visible for ALL authenticated users including admin.
- Issue 3 (P0): Verify typing indicators + read receipts function correctly.
- Issue 4 (P0): Verify 10% bulk discount logic and cart summary display.

**Issues Detail**:

- Issue 1 (Native Layout Parity):
    Description: Home screen in Expo Go shows incorrect hero height and spacing. Web mobile is correct.
    Root Cause: Native branch previously relied on CSS vh units. React Native requires explicit pixel height.
    Correct Implementation Requirement:
        1. Calculate heroHeight = Math.round(Dimensions.get(window).height * 0.26)
        2. Apply height to native hero wrapper container.
        3. Image must fill wrapper (height: 100% or absoluteFillObject).
        4. resizeMode=cover.
        5. Header must respect SafeAreaView or useSafeAreaInsets.
    Next debug checklist:
        1. Restart Expo dev server.
        2. Screenshot Expo Go Home screen (iPhone 14).
        3. Confirm no black gap above hero.
        4. Confirm Shop by Brand aligns visually with web.
        5. Confirm header is below Dynamic Island.
    Status: IN PROGRESS
    Should Test frontend/backend/both after fix?: Frontend

- Issue 2 (Chat FAB Visibility):
    Description: Chat FAB was previously hidden for admins.
    Correct Requirement: Chat FAB must render for ALL authenticated users.
    Behavior on tap: Open same chat modal interface for admin and regular users.
    Next debug checklist:
        1. Log in as admin (jkaatz@gmail.com).
        2. Confirm FAB visible bottom-right.
        3. Confirm FAB opens modal.
    Status: IN PROGRESS
    Should Test frontend/backend/both after fix?: Frontend

- Issue 3 (Chat Enhancements):
    Description: Typing indicators and read receipts were added.
    Requirement:
        - Typing events throttled.
        - Read receipt triggers when message viewed.
        - Works for user and admin sessions.
    Next debug checklist:
        1. Open chat as user.
        2. Log in as admin in second session.
        3. Confirm typing indicator shows live.
        4. Confirm read receipt updates correctly.
    Status: IN PROGRESS
    Should Test frontend/backend/both after fix?: Both

- Issue 4 (Bulk Discount Logic):
    Description: 10% discount should apply when total cart quantity >= 10.
    Correct Logic Specification:
        - Trigger = total quantity across all cart lines >= 10.
        - Discount = 10% of subtotal.
        - Display discount as line item in cart summary.
        - Totals update dynamically.
        - All monetary values rounded to cents.
    Next debug checklist:
        1. Add items until total quantity = 9 → no discount.
        2. Add 10th item → discount activates.
        3. Remove below 10 → discount disappears.
        4. Verify correct math.
    Status: IN PROGRESS
    Should Test frontend/backend/both after fix?: Frontend

**In progress Task List**:
- Task 1 (P0): Validate native layout parity.
- Task 2 (P0): Validate chat enhancements.
- Task 3 (P0): Validate bulk discount.

**Upcoming and Future Tasks**
- P1: Replace base64 product images with proper file upload system in Admin.
- P1: Remove duplicate server_enhanced.py by fixing Railway start command.
- P2: Backend monolith refactor.
- P2: Admin screen modularization.

**Code Architecture**

/app
├── backend
│   └── server.py
├── frontend
│   ├── app/
│   │   ├── (tabs)/
│   │   │   ├── home.tsx
│   │   │   ├── shop.tsx
│   │   │   └── _layout.tsx
│   │   ├── admin/
│   │   │   ├── _layout.tsx
│   │   │   └── chats.tsx
│   │   ├── auth/index.tsx
│   │   └── cart.tsx
│   ├── components/
│   │   ├── ProductCard.tsx
│   │   └── ChatBubble.tsx
│   └── store/
│       ├── authStore.ts
│       └── cartStore.ts
└── server_enhanced.py

**Key API Endpoints**
- WS /api/chat/ws/{token}
- GET /api/chat/messages
- GET /api/admin/chats
- GET /api/admin/chats/{chat_id}/messages

**Critical Info for New Agent**
- You MUST verify layout parity in Expo Go (not just web).
- You MUST confirm FAB visible for admin.
- You MUST validate typing/read receipts in real-time.
- You MUST validate bulk discount logic and cart math.
- Backend changes must remain synced between backend/server.py and server_enhanced.py.
- Use platform file creation tools only.

**Credentials to test flow**
Admin:
Email: jkaatz@gmail.com
Password: Just1n23$

**Project Health Check**
- Native layout parity: Pending validation.
- Chat enhancements: Implemented, pending validation.
- Bulk discount: Implemented, pending validation.
- No confirmed regressions yet.
</analysis>
